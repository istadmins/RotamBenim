<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rotam Benim - Basit Login Test</title>
    
    <!-- Tabler CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/css/tabler.min.css">
    
    <!-- Awesomplete CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css" />
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tabler Autocomplete JS -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/js/tabler.min.js"></script>
    
    <!-- Awesomplete JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>
    
    <style>
        :root {
            --card-opacity: 0.50;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .bg-overlay {
            position: fixed;
            z-index: 0;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            opacity: 0.5;
            background-size: cover;
            background-position: center;
            transition: opacity 0.5s;
        }
        
        .login-container {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-card {
            background: rgba(255,255,255,var(--card-opacity)) !important;
            border-radius: 16px;
            padding: 32px;
            max-width: 1200px;
            width: 100%;
            text-align: center;
        }
        
        .login-logo {
            font-size: 2rem;
            font-weight: 700;
            color: #206bc4;
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            color: #626976;
            margin-bottom: 30px;
        }
        
        .google-btn {
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .google-btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
        }
        
        .google-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .user-info {
            background: transparent !important;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            text-align: left;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
        }
        
        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .status-success {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            margin-top: 30px;
        }
        .table {
            width: 100%;
            min-width: 900px;
            font-size: 14px;
            background: white;
            border-radius: 8px;
            border-collapse: separate;
            border-spacing: 0;
        }
        .table th, .table td {
            padding: 16px 14px;
            white-space: nowrap;
            vertical-align: top;
            min-height: 32px;
            line-height: 1.6;
            text-align: left;
        }
        .table td:last-child {
            text-align: center;
        }
        .table th {
            background: #f1f3f9;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .table td {
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .table td.description {
            max-width: 350px;
            white-space: normal;
            word-break: break-word;
        }
        .country-group-row {
            background: rgba(255,255,255,var(--card-opacity)) !important;
            font-weight: bold;
            font-size: 16px;
            text-align: left;
        }
        #filters { 
            position: relative;
        }
        #suggestions {
            position: absolute;
            left: 0;
            top: 100%;
            width: 350px;
            z-index: 9999;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 6px;
            min-height: 0;
        }
        .awesomplete {
            z-index: 99999 !important;
            position: relative;
        }
        .awesomplete > ul {
            z-index: 99999 !important;
            position: absolute;
        }
        .login-card, #filters {
            overflow: visible !important;
        }
        .table td.name {
            white-space: normal !important;
            word-break: break-word;
        }
    </style>
</head>
<body>
    <div class="bg-overlay" style="position:fixed;z-index:0;top:0;left:0;width:100vw;height:100vh;pointer-events:none;opacity:0.35;background-size:cover;background-position:center;transition:opacity 0.5s;"></div>
    <div class="login-container">
        <div class="login-card">
            <div class="login-logo">üåç Rotam Benim</div>
            
            <!-- Login Button -->
            <button id="googleSignInBtn" class="google-btn">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Google ile Giri≈ü Yap
            </button>
            
            <!-- User Info (hidden by default) -->
            <div id="userInfo" class="user-info" style="display: none;">
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
                    <div>
                        <div id="userName" style="font-weight: 600; font-size: 16px;"></div>
                        <div id="userEmail" style="color: #626976; font-size: 14px;"></div>
                    </div>
                </div>
                <button id="logoutBtn" class="logout-btn">√áƒ±kƒ±≈ü Yap</button>
            </div>
            
            <!-- Status Messages -->
            <div id="statusMessage"></div>
            
            <!-- Filtreler -->
            <div id="filters" style="display: flex; gap: 16px; justify-content: flex-start; align-items: center; margin-bottom: 18px; margin-top: 18px; position: relative;">
              <label for="countryFilter">√úlke:</label>
              <select id="countryFilter" style="min-width: 140px; padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc;"></select>
              <label for="visitedFilter">Ziyaret:</label>
              <select id="visitedFilter" style="min-width: 120px; padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc;">
                <option value="all">T√ºm√º</option>
                <option value="visited">Gezildi</option>
                <option value="notvisited" selected>Gezilmedi</option>
              </select>
              <label for="searchBox">Yeni Yer:</label>
              <input id="searchBox" class="form-control awesomplete" type="text" placeholder="Yeni yer adƒ±..." style="min-width: 180px; padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc;" autocomplete="off" />
              <button id="addPlaceBtn" style="padding: 6px 18px; border-radius: 6px; border: none; background: #206bc4; color: white; font-weight: 500; cursor: pointer;">Ekle</button>
            </div>
            
            <!-- Gezilecek Yerler Tablosu -->
            <div id="placesTableWrapper" class="table-responsive">
              <div id="placesTableContainer" style="margin-top: 0; display: none;">
                <table id="placesTable" class="table table-sm">
                  <thead>
                    <tr>
                      <th>Yer Adƒ±</th>
                      <th>≈ûehir</th>
                      <th>Kategori</th>
                      <th>A√ßƒ±klama</th>
                      <th>Ziyaret Edildi mi?</th>
                      <th>Sil</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Satƒ±rlar buraya eklenecek -->
                  </tbody>
                </table>
              </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB6bIJOkooeRSKWtb09zdNmMIjHDbXCzYA",
            authDomain: "rotambenim.firebaseapp.com",
            projectId: "rotambenim",
            storageBucket: "rotambenim.firebasestorage.app",
            messagingSenderId: "374285362920",
            appId: "1:374285362920:web:b4058cf4a93e7337168b5d",
            measurementId: "G-0QVZ4LDYPJ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // DOM elements
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const userInfo = document.getElementById('userInfo');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const logoutBtn = document.getElementById('logoutBtn');
        const statusMessage = document.getElementById('statusMessage');
        const placesTableContainer = document.getElementById('placesTableContainer');
        const placesTableBody = document.querySelector('#placesTable tbody');
        const addPlaceBtn = document.getElementById('addPlaceBtn');
        const searchBox = document.getElementById('searchBox');
        let suggestionResults = [];
        const GEONAMES_USERNAME = "b.alacam";

        // √úlke isimleri mapping (tr/en)
        const countryNames = {
          'turkey': { tr: 'T√úRKƒ∞YE', en: 'TURKEY' },
          'germany': { tr: 'ALMANYA', en: 'GERMANY' },
          'france': { tr: 'FRANSA', en: 'FRANCE' },
          'italy': { tr: 'ƒ∞TALYA', en: 'ITALY' },
          'spain': { tr: 'ƒ∞SPANYA', en: 'SPAIN' },
          'greece': { tr: 'YUNANƒ∞STAN', en: 'GREECE' },
          'netherlands': { tr: 'HOLLANDA', en: 'NETHERLANDS' },
          'belgium': { tr: 'BEL√áƒ∞KA', en: 'BELGIUM' },
          'austria': { tr: 'AVUSTURYA', en: 'AUSTRIA' },
          'switzerland': { tr: 'ƒ∞SVƒ∞√áRE', en: 'SWITZERLAND' },
          'portugal': { tr: 'PORTEKƒ∞Z', en: 'PORTUGAL' },
          'czech republic': { tr: '√áEK CUMHURƒ∞YETƒ∞', en: 'CZECH REPUBLIC' },
          'poland': { tr: 'POLONYA', en: 'POLAND' },
          'romania': { tr: 'ROMANYA', en: 'ROMANIA' },
          'bulgaria': { tr: 'BULGARƒ∞STAN', en: 'BULGARIA' },
          'latvia': { tr: 'LETONYA', en: 'LATVIA' },
          'lithuania': { tr: 'Lƒ∞TVANYA', en: 'LITHUANIA' },
          'estonia': { tr: 'ESTONYA', en: 'ESTONIA' },
          'hungary': { tr: 'MACARƒ∞STAN', en: 'HUNGARY' },
          'slovakia': { tr: 'SLOVAKYA', en: 'SLOVAKIA' },
          'slovenia': { tr: 'SLOVENYA', en: 'SLOVENIA' },
          'croatia': { tr: 'HIRVATƒ∞STAN', en: 'CROATIA' },
          'serbia': { tr: 'SIRBƒ∞STAN', en: 'SERBIA' },
          'ukraine': { tr: 'UKRAYNA', en: 'UKRAINE' },
          'norway': { tr: 'NORVE√á', en: 'NORWAY' },
          'sweden': { tr: 'ƒ∞SVE√á', en: 'SWEDEN' },
          'finland': { tr: 'Fƒ∞NLANDƒ∞YA', en: 'FINLAND' },
          'south korea': { tr: 'G√úNEY KORE', en: 'SOUTH KOREA' },
          'japan': { tr: 'JAPONYA', en: 'JAPAN' },
          'china': { tr: '√áƒ∞N', en: 'CHINA' },
          'usa': { tr: 'AMERƒ∞KA', en: 'USA' },
          'uk': { tr: 'Bƒ∞RLE≈ûƒ∞K KRALLIK', en: 'UK' },
          // Diƒüer √ºlkeler eklenebilir
        };
        const currentLang = 'tr'; // ƒ∞leride 'en' yapƒ±labilir

        // Show status message
        function showStatus(message, type = 'info') {
            // Status mesajlarƒ± devre dƒ±≈üƒ± bƒ±rakƒ±ldƒ±
            return;
        }

        // Handle Google Sign In
        async function handleGoogleSignIn() {
            try {
                googleSignInBtn.disabled = true;
                showStatus('Google ile giri≈ü yapƒ±lƒ±yor...', 'info');
                
                const provider = new GoogleAuthProvider();
                const result = await signInWithPopup(auth, provider);
                
                console.log('Giri≈ü ba≈üarƒ±lƒ±:', result.user);
                showStatus('Giri≈ü ba≈üarƒ±lƒ±!', 'success');
                
            } catch (error) {
                console.error('Giri≈ü hatasƒ±:', error);
                
                let errorMessage = 'Giri≈ü yapƒ±lƒ±rken bir hata olu≈ütu.';
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Giri≈ü iptal edildi.';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Aƒü hatasƒ±. ƒ∞nternet baƒülantƒ±nƒ±zƒ± kontrol edin.';
                } else if (error.code === 'auth/unauthorized-domain') {
                    errorMessage = 'Bu domain i√ßin giri≈ü yetkisi yok. Firebase Console\'da domain\'i ekleyin.';
                }
                
                showStatus(errorMessage, 'error');
                googleSignInBtn.disabled = false;
            }
        }

        // Handle Sign Out
        async function handleSignOut() {
            try {
                await signOut(auth);
                console.log('√áƒ±kƒ±≈ü ba≈üarƒ±lƒ±');
                showStatus('√áƒ±kƒ±≈ü yapƒ±ldƒ±.', 'success');
            } catch (error) {
                console.error('√áƒ±kƒ±≈ü hatasƒ±:', error);
                showStatus('√áƒ±kƒ±≈ü yapƒ±lƒ±rken hata olu≈ütu.', 'error');
            }
        }

        // Update UI based on auth state
        function updateUI(user) {
            if (user) {
                // User is signed in
                googleSignInBtn.style.display = 'none';
                userInfo.style.display = 'block';
                
                userName.textContent = user.displayName || 'Kullanƒ±cƒ±';
                userEmail.textContent = user.email || '';
                
                if (user.photoURL) {
                    userAvatar.src = user.photoURL;
                } else {
                    userAvatar.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjUiIGZpbGw9IiM2MjY5NzYiLz4KPHN2ZyB4PSIxMiIgeT0iMTIiIHdpZHRoPSIyNiIgaGVpZ2h0PSIyNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAxMmMyLjIxIDAgNC0xLjc5IDQtNHMtMS43OS00LTQtNC00IDEuNzktNCA0IDEuNzkgNCA0IDR6bTAgMmMtMi42NyAwLTggMS4zNC04IDR2MmgxNnYtMmMwLTIuNjYtNS4zMy00LTgtNHoiLz4KPC9zdmc+Cjwvc3ZnPgo=';
                }
                
            } else {
                // User is signed out
                googleSignInBtn.style.display = 'flex';
                userInfo.style.display = 'none';
                googleSignInBtn.disabled = false;
            }
        }

        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            console.log('Auth state changed:', user ? 'User signed in' : 'User signed out');
            updateUI(user);
            
            if (user) {
                // T√ºm pop√ºler yerleri ve √ºlkeleri topla
                const allPopularPlaces = await getAllPopularPlaces();
                const allCountryCodes = await getAllPopularCountryCodes();
                // Kullanƒ±cƒ±nƒ±n mevcut yerlerini √ßek
                const userPlacesRef = collection(db, `users/${user.uid}/places`);
                const snapshot = await getDocs(userPlacesRef);
                const existingPlaces = new Map();
                snapshot.forEach(doc => {
                    const d = doc.data();
                    const key = `${(d.country || '').toUpperCase()}|||${(d.name || '').trim()}`;
                    existingPlaces.set(key, { ...d, docId: doc.id });
                });
                // Eksik pop√ºler yerleri ekle
                let addedCount = 0;
                for (const p of allPopularPlaces) {
                    const country = (p.country_tr || p.country_en || '').toUpperCase();
                    const name = p.name_tr;
                    const key = `${country}|||${name}`;
                    if (!existingPlaces.has(key)) {
                        await addDoc(userPlacesRef, filterUndefinedFields({
                            name: p.name_tr,
                            city: p.city_tr,
                            country: p.country_tr ? p.country_tr.toUpperCase() : undefined,
                            category: p.category_tr,
                            description: p.description_tr,
                            visited: false,
                            name_en: p.name_en,
                            city_en: p.city_en,
                            country_en: p.country_en ? p.country_en.toUpperCase() : undefined,
                            category_en: p.category_en,
                            description_en: p.description_en
                        }));
                        addedCount++;
                    } else {
                        // A√ßƒ±klama eksikse g√ºncelle
                        const place = existingPlaces.get(key);
                        if (!place.description || place.description.trim() === '') {
                            const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js');
                            const docRef = doc(db, `users/${user.uid}/places`, place.docId);
                            await updateDoc(docRef, filterUndefinedFields({
                                description: p.description_tr,
                                name_en: p.name_en,
                                city_en: p.city_en,
                                country_en: p.country_en ? p.country_en.toUpperCase() : undefined,
                                category_en: p.category_en,
                                description_en: p.description_en
                            }));
                        }
                    }
                }
                if (addedCount > 0) showStatus(`${addedCount} yeni pop√ºler yer otomatik eklendi!`, 'success');
                else showStatus('T√ºm pop√ºler yerler zaten mevcut.', 'info');
                // √úlke dropdown'ƒ±nƒ± g√ºncelle
                await updateCountryDropdown(user, allCountryCodes);
            }
            
            loadPlacesTable(user);
        });

        // Event listeners
        googleSignInBtn.addEventListener('click', handleGoogleSignIn);
        logoutBtn.addEventListener('click', handleSignOut);
        
        // Awesomplete ile √∂neri getir
        const awesomplete = new Awesomplete(searchBox, {
          minChars: 2,
          maxItems: 10,
          autoFirst: true,
          list: [],
          item: function(suggestion, input) {
            // A√ßƒ±klama ba≈ülƒ±ƒüƒ±n altƒ±nda deƒüil, ba≈ülƒ±ƒüƒ±n hemen √ºst√ºnde olacak ≈üekilde d√ºzenle
            const html = `<div style='display:flex;flex-direction:column;'>
              <span style='font-size:12px;color:#888;margin-bottom:2px;'>${suggestion.description || ''}</span>
              <strong>${suggestion.label}</strong>
            </div>`;
            const li = document.createElement('li');
            li.innerHTML = html;
            return li;
          },
          replace: function(suggestion) {
            this.input.value = suggestion.label;
          }
        });
        let lastSuggestions = [];
        searchBox.addEventListener('input', async () => {
          const query = searchBox.value.trim();
          if (!query) {
            awesomplete.list = [];
            lastSuggestions = [];
            return;
          }
          // Wikipedia'dan √ßek
          let wikiResults = [];
  try {
            const url = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}+tourism+attraction+place&format=json&origin=*`;
            const resp = await fetch(url);
            const data = await resp.json();
            if (data.query && data.query.search) {
              // Sƒ±kƒ± filtre: sadece gezilecek yer anahtar kelimeleriyle filtrele
              const touristKeywords = [
                "city", "town", "village", "park", "mountain", "lake", "museum", "site", "ruins", "castle", "beach", "island", "national park", "tourist attraction", "region", "province", "district", "valley", "canyon", "bay", "forest", "archaeological", "ancient", "historic", "landmark", "monument", "temple", "cathedral", "mosque", "church", "palace", "bazaar", "market", "bridge", "tower", "garden", "zoo", "aquarium", "harbor", "square", "plaza", "waterfall", "thermal", "spa", "resort", "cave", "gorge", "cliff", "fortress", "citadel", "basilica", "synagogue", "pagoda", "shrine", "observatory", "amphitheater", "arena", "stadium", "theater", "opera", "gallery", "exhibition", "statue", "sculpture", "fountain", "lighthouse", "botanical", "safari", "viewpoint", "panorama", "vista", "lookout", "observation", "peak", "summit"
              ];
              
              // Ki≈üi isimlerini ve yazarlarƒ± filtrelemek i√ßin negatif anahtar kelimeler
              const negativeKeywords = [
                "author", "writer", "novelist", "poet", "politician", "actor", "actress", "director", "producer", "singer", "musician", "composer", "artist", "painter", "sculptor", "philosopher", "scientist", "inventor", "entrepreneur", "businessman", "businesswoman", "athlete", "player", "born", "died", "biography"
              ];
              
              wikiResults = data.query.search.filter(item => {
                const text = (item.title + ' ' + item.snippet).toLowerCase();
                
                // Turistik yer anahtar kelimelerinden en az birini i√ßermeli
                const hasTouristKeyword = touristKeywords.some(kw => text.includes(kw));
                
                // Negatif anahtar kelimelerden hi√ßbirini i√ßermemeli
                const hasNegativeKeyword = negativeKeywords.some(kw => text.includes(kw));
                
                // Turistik yer anahtar kelimesi i√ßermeli VE negatif anahtar kelime i√ßermemeli
                return hasTouristKeyword && !hasNegativeKeyword;
              }).map(item => ({
                label: item.title,
                value: item.title,
                description: item.snippet.replace(/<[^>]+>/g, ''),
                source: 'wikipedia'
              }));
            }
          } catch {}
          // Geonames'den √ßek
          let geoResults = [];
          try {
            // Turistik yerler i√ßin feature code filtresi ekle
            // A (√ºlke, eyalet, b√∂lge), P (≈üehir, k√∂y), L (parklar, alanlar), S (spot, bina, √ßiftlik), T (daƒü, tepe, kaya), H (su k√ºtlesi), V (orman, heath)
            const featureCodes = 'A.ADM1,A.ADM2,A.ADM3,P.PPL,P.PPLA,P.PPLC,L.PRK,L.LCTY,S.BLDG,S.HSE,S.HTL,S.MNMT,S.MSTY,S.OPRA,S.SQR,T.MT,T.HLL,T.VLC,H.LK,H.STM,H.SPNG,H.WTRF,V.FRST';
            const geoUrl = `https://secure.geonames.org/searchJSON?q=${encodeURIComponent(query)}&featureCode=${featureCodes}&maxRows=10&username=${GEONAMES_USERNAME}`;
            const geoResp = await fetch(geoUrl);
            const geoData = await geoResp.json();
            if (geoData.geonames) {
              // Ki≈üi isimlerini filtrelemek i√ßin negatif anahtar kelimeler
              const negativeKeywords = [
                "author", "writer", "novelist", "poet", "politician", "actor", "actress", "director", "producer", "singer", "musician", "composer", "artist", "painter", "sculptor", "philosopher", "scientist", "inventor", "entrepreneur", "businessman", "businesswoman", "athlete", "player"
              ];
              
              geoResults = geoData.geonames
                .filter(g => {
                  // Ki≈üi isimlerini filtrele
                  const text = (g.name + ' ' + (g.fcodeName || '')).toLowerCase();
                  return !negativeKeywords.some(kw => text.includes(kw));
                })
                .map(g => ({
                  label: g.name,
                  value: g.name,
                  description: `${g.countryName || ''} ${g.fcodeName || ''}`,
                  source: 'geonames'
                }));
            }
          } catch {}
          // Pop√ºler yerlerden arama yap
          let popularResults = [];
          try {
            const response = await fetch('/popular-places.json');
            const popularPlaces = await response.json();
            // Hem T√ºrk√ße hem ƒ∞ngilizce isimlerde arama yap
            popularResults = popularPlaces
              .filter(p => {
                const nameTr = (p.name_tr || '').toLowerCase();
                const nameEn = (p.name_en || '').toLowerCase();
                const cityTr = (p.city_tr || '').toLowerCase();
                const cityEn = (p.city_en || '').toLowerCase();
                const searchQuery = query.toLowerCase();
                
                return nameTr.includes(searchQuery) || 
                       nameEn.includes(searchQuery) || 
                       cityTr.includes(searchQuery) || 
                       cityEn.includes(searchQuery);
              })
              .map(p => ({
                label: p.name_tr,
                value: p.name_tr,
                description: `${p.city_tr || ''}, ${p.country_tr || ''} - ${p.category_tr || ''}`,
                source: 'popular',
                data: p // T√ºm veriyi sakla
              }));
          } catch {}
          
          // Sonu√ßlarƒ± birle≈ütir ve sƒ±rala (pop√ºler yerler √∂nce gelsin)
          const allResults = [...popularResults, ...wikiResults, ...geoResults].filter((v, i, a) =>
            a.findIndex(t => t.value === v.value) === i
          );
          awesomplete.list = allResults;
          lastSuggestions = allResults;
        });
        // Se√ßim veya enter ile ekle
        searchBox.addEventListener('awesomplete-selectcomplete', async (e) => {
          const user = auth.currentUser;
          if (!user) {
            showStatus('Giri≈ü yapmadan yer ekleyemezsiniz.', 'error');
            return;
          }
          const selectedLabel = searchBox.value.trim();
          const item = lastSuggestions.find(s => s.label === selectedLabel) || { value: selectedLabel, description: '', source: 'manual' };
          addPlaceBtn.disabled = true;
          try {
            // Eƒüer se√ßilen √∂ƒüe pop√ºler yerlerden geldiyse, doƒürudan o veriyi kullan
            if (item.source === 'popular' && item.data) {
              const placeData = item.data;
              await addDoc(collection(db, `users/${user.uid}/places`), {
                name: placeData.name_tr || item.value,
                city: placeData.city_tr || '',
                country: (placeData.country_tr || '').toUpperCase(),
                category: placeData.category_tr || '',
                description: placeData.description_tr || item.description || '',
                visited: false,
                name_en: placeData.name_en || '',
                city_en: placeData.city_en || '',
                country_en: (placeData.country_en || '').toUpperCase(),
                category_en: placeData.category_en || '',
                description_en: placeData.description_en || ''
              });
            } else {
              // Pop√ºler yerler JSON'unda arama
              let placeData = null;
              try {
                const response = await fetch('/popular-places.json');
                const popularPlaces = await response.json();
                // Hem T√ºrk√ße hem ƒ∞ngilizce isme bak
                placeData = popularPlaces.find(p =>
                  p.name_tr?.toLowerCase() === selectedLabel.toLowerCase() ||
                  p.name_en?.toLowerCase() === selectedLabel.toLowerCase()
                );
              } catch {}
              
              // Eƒüer pop√ºler yerler JSON'unda varsa, t√ºm alanlarƒ± oradan doldur
              if (placeData) {
                await addDoc(collection(db, `users/${user.uid}/places`), {
                  name: placeData.name_tr || item.value,
                  city: placeData.city_tr || '',
                  country: (placeData.country_tr || '').toUpperCase(),
                  category: placeData.category_tr || '',
                  description: placeData.description_tr || item.description || '',
                  visited: false,
                  name_en: placeData.name_en || '',
                  city_en: placeData.city_en || '',
                  country_en: (placeData.country_en || '').toUpperCase(),
                  category_en: placeData.category_en || '',
                  description_en: placeData.description_en || ''
                });
              } else {
                // Yoksa, mevcut mantƒ±kla ekle ama √ºlkeyi se√ßili √ºlke yap
                await addDoc(collection(db, `users/${user.uid}/places`), {
                  name: item.value,
                  city: '',
                  country: (countryFilter.value || '').toUpperCase(),
                  category: '',
                  description: item.description || '',
                  visited: false
                });
              }
            }
            showStatus('Yeni yer eklendi!', 'success');
            searchBox.value = '';
            addPlaceBtn.disabled = false;
            loadPlacesTable(user);
          } catch (err) {
            showStatus('Yer eklenirken hata: ' + err.message, 'error');
            addPlaceBtn.disabled = false;
          }
        });

        // Initialize
        console.log('Firebase initialized successfully');
        showStatus('Uygulama hazƒ±r. Giri≈ü yapabilirsiniz.', 'info');

        // Pop√ºler yerler JSON'ƒ±nƒ± y√ºkle ve i≈üle
        async function loadPopularPlaces() {
          try {
            const response = await fetch('/popular-places.json');
            const popularPlaces = await response.json();
            return popularPlaces;
          } catch (error) {
            console.error('Pop√ºler yerler y√ºklenemedi:', error);
            return [];
          }
        }

        // Yeni kullanƒ±cƒ± i√ßin pop√ºler yerleri y√ºkle
        async function loadPopularPlacesForNewUser(user) {
          try {
            const popularPlaces = await loadPopularPlaces();
            const userPlacesRef = collection(db, `users/${user.uid}/places`);
            
            // Kullanƒ±cƒ±nƒ±n mevcut yerlerini kontrol et
            const existingSnapshot = await getDocs(userPlacesRef);
            const existingPlaces = new Set();
            existingSnapshot.forEach(doc => {
              const data = doc.data();
              // Hem T√ºrk√ße hem ƒ∞ngilizce isimleri kontrol et
              existingPlaces.add(`${data.name}-${data.country}`);
              if (data.name_en) {
                existingPlaces.add(`${data.name_en}-${data.country_en || data.country}`);
              }
            });

            // Pop√ºler yerleri ekle (eƒüer yoksa)
            let addedCount = 0;
            for (const place of popularPlaces) {
              const placeKeyTr = `${place.name_tr}-${place.country_tr.toUpperCase()}`;
              const placeKeyEn = `${place.name_en}-${place.country_en.toUpperCase()}`;
              
              if (!existingPlaces.has(placeKeyTr) && !existingPlaces.has(placeKeyEn)) {
                await addDoc(userPlacesRef, {
                  name: place.name_tr,
                  city: place.city_tr,
                  country: place.country_tr.toUpperCase(),
                  category: place.category_tr,
                  description: place.description_tr,
                  visited: false,
                  name_en: place.name_en,
                  city_en: place.city_en,
                  country_en: place.country_en.toUpperCase(),
                  category_en: place.category_en,
                  description_en: place.description_en
                });
                addedCount++;
              }
            }
            
            if (addedCount > 0) {
              showStatus(`${addedCount} pop√ºler yer eklendi!`, 'success');
            } else {
              showStatus('T√ºm pop√ºler yerler zaten mevcut.', 'info');
            }
          } catch (error) {
            console.error('Pop√ºler yerler y√ºklenirken hata:', error);
            showStatus('Pop√ºler yerler y√ºklenirken hata olu≈ütu: ' + error.message, 'error');
          }
        }

        // Firestore'a undefined alan g√∂ndermeyi engelleyen yardƒ±mcƒ± fonksiyon
        function filterUndefinedFields(obj) {
          const result = {};
          for (const key in obj) {
            if (obj[key] !== undefined) {
              result[key] = obj[key];
            }
          }
          return result;
        }

        // Mevcut kullanƒ±cƒ± i√ßin eksik a√ßƒ±klamalarƒ± doldur
        async function fillMissingDescriptions(user) {
          try {
            const popularPlaces = await loadPopularPlaces();
            const userPlacesRef = collection(db, `users/${user.uid}/places`);
            const snapshot = await getDocs(userPlacesRef);
            
            let updatedCount = 0;
            const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js');
            
            for (const docSnapshot of snapshot.docs) {
              const data = docSnapshot.data();
              // A√ßƒ±klama eksikse pop√ºler yerlerden bul
              if (!data.description || data.description.trim() === '') {
                // Hem T√ºrk√ße hem ƒ∞ngilizce isimlerle e≈üle≈ütir
                let matchingPlace = popularPlaces.find(place => 
                  (place.name_tr === data.name && place.country_tr.toUpperCase() === data.country) ||
                  (place.name_en === data.name && place.country_en.toUpperCase() === data.country)
                );
                
                // Eƒüer bulunamazsa, sadece isimle e≈üle≈ütir
                if (!matchingPlace) {
                  matchingPlace = popularPlaces.find(place => 
                    place.name_tr === data.name || place.name_en === data.name
                  );
                }
                
                if (matchingPlace) {
                  const docRef = doc(db, `users/${user.uid}/places`, docSnapshot.id);
                  await updateDoc(docRef, {
                    description: matchingPlace.description_tr,
                    name_en: matchingPlace.name_en,
                    city_en: matchingPlace.city_en,
                    country_en: matchingPlace.country_en.toUpperCase(),
                    category_en: matchingPlace.category_en,
                    description_en: matchingPlace.description_en
                  });
                  updatedCount++;
                }
              }
            }
            
            if (updatedCount > 0) {
              showStatus(`${updatedCount} yerin a√ßƒ±klamasƒ± g√ºncellendi!`, 'success');
            } else {
              showStatus('G√ºncellenecek a√ßƒ±klama bulunamadƒ±.', 'info');
            }
          } catch (error) {
            console.error('A√ßƒ±klamalar doldurulurken hata:', error);
            showStatus('A√ßƒ±klamalar doldurulurken hata olu≈ütu: ' + error.message, 'error');
          }
        }

        // √úlke kayƒ±tlarƒ±nƒ± birle≈ütir ve eksik yerleri ekle
        async function mergeCountriesAndAddMissingPlaces(user) {
          try {
            const popularPlaces = await loadPopularPlaces();
            const userPlacesRef = collection(db, `users/${user.uid}/places`);
            const snapshot = await getDocs(userPlacesRef);
            const { doc, updateDoc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js');

            // T√ºm yerleri √ºlke+isim kombinasyonuna g√∂re grupla
            const placeMap = new Map();
            const toDelete = [];
            for (const docSnapshot of snapshot.docs) {
              const data = docSnapshot.data();
              const country = (data.country || '').toUpperCase();
              const name = (data.name || '').trim();
              const key = `${country}|||${name}`;
              if (!placeMap.has(key)) {
                placeMap.set(key, { ...data, docId: docSnapshot.id });
              } else {
                // Aynƒ± √ºlke ve isimde birden fazla kayƒ±t varsa, sadece birini bƒ±rak
                toDelete.push(docSnapshot.id);
              }
            }

            // Silinecek tekrar eden kayƒ±tlarƒ± sil
            for (const docId of toDelete) {
              const docRef = doc(db, `users/${user.uid}/places`, docId);
              await deleteDoc(docRef);
            }

            // A√ßƒ±klamalarƒ± g√ºncelle ve eksik pop√ºler yerleri ekle
            let updatedCount = 0;
            let addedCount = 0;
            const existingKeys = new Set(placeMap.keys());
            // A√ßƒ±klamalarƒ± g√ºncelle
            for (const [key, place] of placeMap.entries()) {
              if (!place.description || place.description.trim() === '') {
                const [country, name] = key.split('|||');
                const matching = popularPlaces.find(p =>
                  (p.country_tr && p.country_tr.toUpperCase() === country && p.name_tr === name) ||
                  (p.country_en && p.country_en.toUpperCase() === country && p.name_en === name)
                );
                if (matching) {
                  const docRef = doc(db, `users/${user.uid}/places`, place.docId);
                  await updateDoc(docRef, filterUndefinedFields({
                    description: matching.description_tr,
                    name_en: matching.name_en,
                    city_en: matching.city_en,
                    country_en: matching.country_en ? matching.country_en.toUpperCase() : undefined,
                    category_en: matching.category_en,
                    description_en: matching.description_en
                  }));
                  updatedCount++;
                }
              }
            }
            // Eksik pop√ºler yerleri ekle
            for (const p of popularPlaces) {
              const country = (p.country_tr || p.country_en || '').toUpperCase();
              const name = p.name_tr;
              const key = `${country}|||${name}`;
              if (!existingKeys.has(key)) {
                await addDoc(userPlacesRef, filterUndefinedFields({
                  name: p.name_tr,
                  city: p.city_tr,
                  country: p.country_tr ? p.country_tr.toUpperCase() : undefined,
                  category: p.category_tr,
                  description: p.description_tr,
                  visited: false,
                  name_en: p.name_en,
                  city_en: p.city_en,
                  country_en: p.country_en ? p.country_en.toUpperCase() : undefined,
                  category_en: p.category_en,
                  description_en: p.description_en
                }));
                addedCount++;
              }
            }
            let msg = '';
            if (toDelete.length > 0) msg += `${toDelete.length} tekrar eden kayƒ±t silindi. `;
            if (updatedCount > 0) msg += `${updatedCount} a√ßƒ±klama g√ºncellendi. `;
            if (addedCount > 0) msg += `${addedCount} yeni yer eklendi.`;
            if (!msg) msg = 'Herhangi bir deƒüi≈üiklik yapƒ±lmadƒ±.';
            showStatus(msg, 'success');
          } catch (error) {
            console.error('√úlke birle≈ütirme hatasƒ±:', error);
            showStatus('√úlke birle≈ütirme hatasƒ±: ' + error.message, 'error');
          }
        }

        async function loadPlacesTable(user) {
          if (!user) {
            placesTableContainer.style.display = 'none';
            return;
          }
          // Kullanƒ±cƒ±ya ait places koleksiyonu yolu
          const placesCol = collection(db, `users/${user.uid}/places`);
          const snapshot = await getDocs(placesCol);

          // Tabloyu temizle
          placesTableBody.innerHTML = '';

          // Filtre comboboxlarƒ±nƒ± hazƒ±rla
          const countryFilter = document.getElementById('countryFilter');
          const visitedFilter = document.getElementById('visitedFilter');
          // Arama kutusu sadece √∂neri i√ßin, filtreleme yok

          // T√ºm √ºlkeleri topla ve normalize et
          const places = [];
          const countrySet = new Set();
          snapshot.forEach(doc => {
            const data = doc.data();
            places.push({ ...data, _docId: doc.id });
            if (data.country) {
              // ƒ∞ngilizce anahtara normalize et
              const englishKey = getEnglishCountryKeySafe(data.country);
              countrySet.add(englishKey);
            }
          });
          const countries = Array.from(countrySet).sort();

          // T√ºrk√ße isme g√∂re sƒ±rala
          countries.sort((a, b) => {
            const trA = toTurkishUpper(countryNames[a]?.[currentLang] || a);
            const trB = toTurkishUpper(countryNames[b]?.[currentLang] || b);
            return trA.localeCompare(trB, 'tr');
          });
          // √úlke combobox'ƒ±nƒ± doldur (sadece ilk y√ºklemede veya √ºlke sayƒ±sƒ± deƒüi≈ütiyse)
          if (countryFilter.options.length === 0 || countryFilter.options.length !== countries.length) {
            countryFilter.innerHTML = '';
            countries.forEach(englishKey => {
              const opt = document.createElement('option');
              opt.value = englishKey;
              const trName = countryNames[englishKey]?.[currentLang] || englishKey;
              opt.textContent = toTurkishUpper(trName);
              countryFilter.appendChild(opt);
            });
          }
          // Varsayƒ±lan √ºlke: ALMANYA
          if (!countryFilter.value) countryFilter.value = 'ALMANYA';
          // Varsayƒ±lan ziyaret filtresi: Gezilmedi
          if (!visitedFilter.value) visitedFilter.value = 'notvisited';

          // Filtreye g√∂re verileri s√ºz
          let filtered = [];
          const selectedCountry = countryFilter.value;
          const selectedVisited = visitedFilter.value;
          filtered = places.filter(p => getEnglishCountryKeySafe(p.country) === selectedCountry);
          if (selectedVisited === 'visited') filtered = filtered.filter(p => p.visited);
          else if (selectedVisited === 'notvisited') filtered = filtered.filter(p => !p.visited);

          filtered.sort((a, b) => (a.city || '').localeCompare(b.city || ''));
          filtered.forEach(data => {
            const row = document.createElement('tr');
            const categoryHtml = (data.category || '').replace(/\s*\/\s*/g, '<br>');
            row.innerHTML = `
              <td class="name">${data.name || ''}</td>
              <td>${data.city || ''}</td>
              <td>${categoryHtml}</td>
              <td class="description">${data.description || ''}</td>
              <td style="text-align:center;"><input type="checkbox" class="visited-checkbox" data-docid="${data._docId}" ${data.visited ? 'checked' : ''}></td>
              <td style="text-align:center;"><button class="delete-place-btn" data-docid="${data._docId}" style="background:#dc3545;color:white;border:none;padding:4px 10px;border-radius:5px;cursor:pointer;">Sil</button></td>
            `;
            placesTableBody.appendChild(row);
          });

          // Checkbox event listener
          document.querySelectorAll('.visited-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', async (e) => {
              const docId = e.target.getAttribute('data-docid');
              const checked = e.target.checked;
              try {
                const placeDocRef = collection(db, `users/${user.uid}/places`);
                // Firestore doc() ile referans olu≈ütur
                const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js');
                const ref = doc(db, `users/${user.uid}/places`, docId);
                await updateDoc(ref, { visited: checked });
              } catch (err) {
                alert('G√ºncelleme hatasƒ±: ' + err.message);
                e.target.checked = !checked; // Hata olursa eski haline d√∂nd√ºr
              }
            });
          });

          // Silme butonu event listener
          document.querySelectorAll('.delete-place-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              const docId = e.target.getAttribute('data-docid');
              if (!confirm('Bu yeri silmek istediƒüinize emin misiniz?')) return;
              try {
                const { doc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js');
                const ref = doc(db, `users/${user.uid}/places`, docId);
                await deleteDoc(ref);
                showStatus('Yer silindi.', 'success');
                loadPlacesTable(user);
              } catch (err) {
                showStatus('Silme hatasƒ±: ' + err.message, 'error');
              }
            });
          });

          placesTableContainer.style.display = '';
        }

        // Filtre deƒüi≈üince tabloyu g√ºncelle
        document.addEventListener('DOMContentLoaded', () => {
          const countryFilter = document.getElementById('countryFilter');
          const visitedFilter = document.getElementById('visitedFilter');
          if (countryFilter && visitedFilter) {
            countryFilter.addEventListener('change', () => {
              const user = auth.currentUser;
              if (user) loadPlacesTable(user);
              if (window.enhancedBackgroundManager) {
                window.enhancedBackgroundManager.updateBackgroundForCountry(countryFilter.value);
              }
            });
            visitedFilter.addEventListener('change', () => {
              const user = auth.currentUser;
              if (user) loadPlacesTable(user);
            });
          }
        });
        
        // Sayfa tamamen y√ºklendikten sonra arka planƒ± g√ºncelle
        window.addEventListener('load', () => {
          const countryFilter = document.getElementById('countryFilter');
          if (countryFilter && window.enhancedBackgroundManager) {
            console.log('Sayfa y√ºklendi, arka plan g√ºncelleniyor:', countryFilter.value);
            window.enhancedBackgroundManager.updateBackgroundForCountry(countryFilter.value);
          }
        });

        // T√ºm pop√ºler √ºlke JSON dosyalarƒ±nƒ± otomatik bul ve oku
        async function getAllPopularCountryFiles() {
          // public/json/popular-*.json dosyalarƒ±nƒ± bulmak i√ßin bir endpoint veya sabit liste gerekir
          // Burada sabit bir listeyle ilerliyoruz (daha sonra dinamik yapƒ±labilir)
          const countryFiles = [
            'popular-germany.json', 'popular-france.json', 'popular-italy.json', 'popular-spain.json', 'popular-netherlands.json',
            'popular-switzerland.json', 'popular-belgium.json', 'popular-austria.json', 'popular-poland.json', 'popular-czech-republic.json',
            'popular-hungary.json', 'popular-romania.json', 'popular-greece.json', 'popular-portugal.json', 'popular-croatia.json',
            'popular-slovenia.json', 'popular-bulgaria.json', 'popular-slovakia.json', 'popular-estonia.json', 'popular-latvia.json',
            'popular-lithuania.json', 'popular-south-korea.json', 'popular-japan.json', 'popular-turkey.json', 'popular-uk.json', 'popular-ireland.json'
          ];
          const base = '/json/';
          const all = [];
          for (const file of countryFiles) {
            try {
              const resp = await fetch(base + file);
              if (resp.ok) {
                const arr = await resp.json();
                all.push({ file, arr });
              }
            } catch {}
          }
          return all;
        }

        // T√ºm √ºlkelerin kodlarƒ±nƒ± ve isimlerini d√∂nd√ºr
        async function getAllPopularCountryCodes() {
          const all = await getAllPopularCountryFiles();
          const codes = new Set();
          all.forEach(({ arr }) => {
            arr.forEach(p => {
              if (p.country_tr) codes.add(p.country_tr.toUpperCase());
              if (p.country_en) codes.add(p.country_en.toUpperCase());
            });
          });
          return Array.from(codes).sort();
        }

        // T√ºm pop√ºler yerleri tek dizi olarak d√∂nd√ºr
        async function getAllPopularPlaces() {
          const all = await getAllPopularCountryFiles();
          return all.flatMap(({ arr }) => arr);
        }

        // √úlke dropdown'ƒ±nƒ± t√ºm pop√ºler √ºlkelerle g√ºncelle
        async function updateCountryDropdown(user, allCountryCodes) {
          const countryFilter = document.getElementById('countryFilter');
          if (!countryFilter) return;
          countryFilter.innerHTML = '';
          allCountryCodes.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.textContent = c;
            countryFilter.appendChild(opt);
          });
          // Kullanƒ±cƒ±nƒ±n mevcut √ºlkesini koru
          if (!countryFilter.value) countryFilter.value = 'ALMANYA';
        }

        function getEnglishCountryKeySafe(country) {
          if (window.enhancedBackgroundManager && typeof window.enhancedBackgroundManager.getEnglishCountryKey === 'function') {
            return window.enhancedBackgroundManager.getEnglishCountryKey(country);
          }
          // Local fallback (kƒ±sa versiyon)
          const map = {
            't√ºrkiye': 'turkey', 'almanya': 'germany', 'fransa': 'france', 'italya': 'italy', 'ispanya': 'spain',
            'yunanistan': 'greece', 'hollanda': 'netherlands', 'bel√ßika': 'belgium', 'avusturya': 'austria',
            'isvi√ßre': 'switzerland', 'portekiz': 'portugal', '√ßek cumhuriyeti': 'czech republic', 'polonya': 'poland',
            'romanya': 'romania', 'bulgaristan': 'bulgaria', 'letonya': 'latvia', 'litvanya': 'lithuania',
            'estonya': 'estonia', 'macaristan': 'hungary', 'slovakya': 'slovakia', 'slovenya': 'slovenia',
            'hirvatistan': 'croatia', 'sƒ±rbistan': 'serbia', 'ukrayna': 'ukraine', 'norve√ß': 'norway',
            'isve√ß': 'sweden', 'finlandiya': 'finland', 'g√ºney kore': 'south korea', 'japonya': 'japan',
            '√ßin': 'china', 'abd': 'usa', 'amerika': 'usa', 'birle≈üik krallƒ±k': 'uk'
          };
          const norm = country.toLowerCase().replace(/√ß/g,'c').replace(/ƒü/g,'g').replace(/ƒ±/g,'i').replace(/√∂/g,'o').replace(/≈ü/g,'s').replace(/√º/g, 'u');
          return map[norm] || norm;
        }

        // Geli≈ümi≈ü T√ºrk√ße b√ºy√ºk harf d√∂n√º≈ü√ºm√º fonksiyonu
        function toTurkishUpper(str) {
          return str
            .replace(/i/g, 'ƒ∞')
            .replace(/ƒ±/g, 'I')
            .replace(/I/g, 'ƒ∞')
            .replace(/≈ü/g, '≈û')
            .replace(/ƒü/g, 'ƒû')
            .replace(/√º/g, '√ú')
            .replace(/√∂/g, '√ñ')
            .replace(/√ß/g, '√á')
            .toUpperCase();
        }

        // --- √úlke combobox'ƒ±nƒ± T√ºrk√ße isme g√∂re alfabetik sƒ±rala ---
        async function updateCountryDropdownWithPopularOnly() {
          const countryFilter = document.getElementById('countryFilter');
          if (!countryFilter) return;
          // 1. Pop√ºler √ºlkeleri oku
          const allPopular = await getAllPopularCountryCodes(); // normalize edilmi≈ü ƒ∞ngilizce anahtarlar
          // 2. Tekrarlarƒ± engelle
          const allCountries = Array.from(new Set(allPopular));
          // 3. T√ºrk√ße isme g√∂re sƒ±rala
          allCountries.sort((a, b) => {
            const trA = toTurkishUpper(countryNames[a]?.[currentLang] || a);
            const trB = toTurkishUpper(countryNames[b]?.[currentLang] || b);
            return trA.localeCompare(trB, 'tr');
          });
          // 4. Dropdown'u doldur
          countryFilter.innerHTML = '';
          allCountries.forEach(englishKey => {
            const opt = document.createElement('option');
            opt.value = englishKey;
            const trName = countryNames[englishKey]?.[currentLang] || englishKey;
            opt.textContent = toTurkishUpper(trName);
            countryFilter.appendChild(opt);
          });
          // Varsayƒ±lan √ºlke: ALMANYA
          if (!countryFilter.value && allCountries.includes('germany')) {
            countryFilter.value = 'germany';
            // √úlke se√ßildiƒüinde arka planƒ± g√ºncelle
            if (window.enhancedBackgroundManager) {
              console.log('Varsayƒ±lan √ºlke se√ßildi, arka plan g√ºncelleniyor:', countryFilter.value);
              setTimeout(() => {
                window.enhancedBackgroundManager.updateBackgroundForCountry(countryFilter.value);
              }, 200);
            }
          }
        }

        // --- Sayfa ilk a√ßƒ±ldƒ±ƒüƒ±nda ve kullanƒ±cƒ± deƒüi≈ütiƒüinde √ºlke dropdown'unu g√ºncelle ---
        document.addEventListener('DOMContentLoaded', () => {
          updateCountryDropdownWithPopularOnly();
        });
    </script>
    <script src="/js/enhanced-background-manager.js"></script>
</body>

</html>