<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rotam Benim - Basit Login Test</title>
    
    <!-- Tabler CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/css/tabler.min.css">
    
    <!-- Awesomplete CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css" />
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tabler Autocomplete JS -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/js/tabler.min.js"></script>
    
    <!-- Awesomplete JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>
    
    <style>
        :root {
            --card-opacity: 0;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .bg-overlay {
            position: fixed;
            z-index: 0;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            opacity: 0.35;
            background-size: cover;
            background-position: center;
            transition: opacity 0.5s;
        }
        
        .login-container {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-card {
            background: rgba(255,255,255,var(--card-opacity)) !important;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 32px;
            max-width: 1200px;
            width: 100%;
            text-align: center;
        }
        
        .login-logo {
            font-size: 2rem;
            font-weight: 700;
            color: #206bc4;
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            color: #626976;
            margin-bottom: 30px;
        }
        
        .google-btn {
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .google-btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
        }
        
        .google-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .user-info {
            background: rgba(255,255,255,var(--card-opacity)) !important;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            text-align: left;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
        }
        
        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .status-success {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            margin-top: 30px;
        }
        .table {
            width: 100%;
            min-width: 900px;
            font-size: 14px;
            background: white;
            border-radius: 8px;
            border-collapse: separate;
            border-spacing: 0;
        }
        .table th, .table td {
            padding: 16px 14px;
            white-space: nowrap;
            vertical-align: top;
            min-height: 32px;
            line-height: 1.6;
            text-align: left;
        }
        .table td:last-child {
            text-align: center;
        }
        .table th {
            background: #f1f3f9;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .table td {
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .table td.description {
            max-width: 350px;
            white-space: normal;
            word-break: break-word;
        }
        .country-group-row {
            background: rgba(255,255,255,var(--card-opacity)) !important;
            font-weight: bold;
            font-size: 16px;
            text-align: left;
        }
        #filters { 
            position: relative;
        }
        #suggestions {
            position: absolute;
            left: 0;
            top: 100%;
            width: 350px;
            z-index: 9999;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            min-height: 0;
        }
        .awesomplete {
            z-index: 99999 !important;
            position: relative;
        }
        .awesomplete > ul {
            z-index: 99999 !important;
            position: absolute;
        }
        .login-card, #filters {
            overflow: visible !important;
        }
        .table td.name {
            white-space: normal !important;
            word-break: break-word;
        }
    </style>
</head>
<body>
    <div class="bg-overlay" style="position:fixed;z-index:0;top:0;left:0;width:100vw;height:100vh;pointer-events:none;opacity:0.35;background-size:cover;background-position:center;transition:opacity 0.5s;"></div>
    <div class="login-container">
        <div class="login-card">
            <div class="login-logo">�� Rotam Benim</div>
            
            <!-- Login Button -->
            <button id="googleSignInBtn" class="google-btn">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Google ile Giriş Yap
            </button>
            
            <!-- User Info (hidden by default) -->
            <div id="userInfo" class="user-info" style="display: none;">
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
                    <div>
                        <div id="userName" style="font-weight: 600; font-size: 16px;"></div>
                        <div id="userEmail" style="color: #626976; font-size: 14px;"></div>
                    </div>
                </div>
                <button id="logoutBtn" class="logout-btn">Çıkış Yap</button>
            </div>
            
            <!-- Status Messages -->
            <div id="statusMessage"></div>
            
            <!-- Filtreler -->
            <div id="filters" style="display: flex; gap: 16px; justify-content: flex-start; align-items: center; margin-bottom: 18px; margin-top: 18px; position: relative;">
              <label for="countryFilter">Ülke:</label>
              <select id="countryFilter" style="min-width: 140px; padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc;"></select>
              <label for="visitedFilter">Ziyaret:</label>
              <select id="visitedFilter" style="min-width: 120px; padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc;">
                <option value="all">Tümü</option>
                <option value="visited">Gezildi</option>
                <option value="notvisited" selected>Gezilmedi</option>
              </select>
              <label for="searchBox">Yeni Yer:</label>
              <input id="searchBox" class="form-control awesomplete" type="text" placeholder="Yeni yer adı..." style="min-width: 180px; padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc;" autocomplete="off" />
              <button id="addPlaceBtn" style="padding: 6px 18px; border-radius: 6px; border: none; background: #206bc4; color: white; font-weight: 500; cursor: pointer;">Ekle</button>
            </div>
            
            <!-- Gezilecek Yerler Tablosu -->
            <div id="placesTableWrapper" class="table-responsive">
              <div id="placesTableContainer" style="margin-top: 0; display: none;">
                <table id="placesTable" class="table table-sm">
                  <thead>
                    <tr>
                      <th>Yer Adı</th>
                      <th>Şehir</th>
                      <th>Kategori</th>
                      <th>Açıklama</th>
                      <th>Ziyaret Edildi mi?</th>
                      <th>Sil</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Satırlar buraya eklenecek -->
                  </tbody>
                </table>
              </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB6bIJOkooeRSKWtb09zdNmMIjHDbXCzYA",
            authDomain: "rotambenim.firebaseapp.com",
            projectId: "rotambenim",
            storageBucket: "rotambenim.firebasestorage.app",
            messagingSenderId: "374285362920",
            appId: "1:374285362920:web:b4058cf4a93e7337168b5d",
            measurementId: "G-0QVZ4LDYPJ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // DOM elements
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const userInfo = document.getElementById('userInfo');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const logoutBtn = document.getElementById('logoutBtn');
        const statusMessage = document.getElementById('statusMessage');
        const placesTableContainer = document.getElementById('placesTableContainer');
        const placesTableBody = document.querySelector('#placesTable tbody');
        const addPlaceBtn = document.getElementById('addPlaceBtn');
        const searchBox = document.getElementById('searchBox');
        let suggestionResults = [];
        const GEONAMES_USERNAME = "b.alacam";

        // Ülke isimleri mapping (tr/en)
        const countryNames = {
          'turkey': { tr: 'TÜRKİYE', en: 'TURKEY' },
          'germany': { tr: 'ALMANYA', en: 'GERMANY' },
          'france': { tr: 'FRANSA', en: 'FRANCE' },
          'italy': { tr: 'İTALYA', en: 'ITALY' },
          'spain': { tr: 'İSPANYA', en: 'SPAIN' },
          'greece': { tr: 'YUNANİSTAN', en: 'GREECE' },
          'netherlands': { tr: 'HOLLANDA', en: 'NETHERLANDS' },
          'belgium': { tr: 'BELÇİKA', en: 'BELGIUM' },
          'austria': { tr: 'AVUSTURYA', en: 'AUSTRIA' },
          'switzerland': { tr: 'İSVİÇRE', en: 'SWITZERLAND' },
          'portugal': { tr: 'PORTEKİZ', en: 'PORTUGAL' },
          'czech republic': { tr: 'ÇEK CUMHURİYETİ', en: 'CZECH REPUBLIC' },
          'poland': { tr: 'POLONYA', en: 'POLAND' },
          'romania': { tr: 'ROMANYA', en: 'ROMANIA' },
          'bulgaria': { tr: 'BULGARİSTAN', en: 'BULGARIA' },
          'latvia': { tr: 'LETONYA', en: 'LATVIA' },
          'lithuania': { tr: 'LİTVANYA', en: 'LITHUANIA' },
          'estonia': { tr: 'ESTONYA', en: 'ESTONIA' },
          'hungary': { tr: 'MACARİSTAN', en: 'HUNGARY' },
          'slovakia': { tr: 'SLOVAKYA', en: 'SLOVAKIA' },
          'slovenia': { tr: 'SLOVENYA', en: 'SLOVENIA' },
          'croatia': { tr: 'HIRVATİSTAN', en: 'CROATIA' },
          'serbia': { tr: 'SIRBİSTAN', en: 'SERBIA' },
          'ukraine': { tr: 'UKRAYNA', en: 'UKRAINE' },
          'norway': { tr: 'NORVEÇ', en: 'NORWAY' },
          'sweden': { tr: 'İSVEÇ', en: 'SWEDEN' },
          'finland': { tr: 'FİNLANDİYA', en: 'FINLAND' },
          'south korea': { tr: 'GÜNEY KORE', en: 'SOUTH KOREA' },
          'japan': { tr: 'JAPONYA', en: 'JAPAN' },
          'china': { tr: 'ÇİN', en: 'CHINA' },
          'usa': { tr: 'AMERİKA', en: 'USA' },
          'uk': { tr: 'BİRLEŞİK KRALLIK', en: 'UK' },
          // Diğer ülkeler eklenebilir
        };
        const currentLang = 'tr'; // İleride 'en' yapılabilir

        // Show status message
        function showStatus(message, type = 'info') {
            statusMessage.innerHTML = `<div class="status-${type}">${message}</div>`;
            setTimeout(() => {
                statusMessage.innerHTML = '';
            }, 5000);
        }

        // Handle Google Sign In
        async function handleGoogleSignIn() {
            try {
                googleSignInBtn.disabled = true;
                showStatus('Google ile giriş yapılıyor...', 'info');
                
                const provider = new GoogleAuthProvider();
                const result = await signInWithPopup(auth, provider);
                
                console.log('Giriş başarılı:', result.user);
                showStatus('Giriş başarılı!', 'success');
                
            } catch (error) {
                console.error('Giriş hatası:', error);
                
                let errorMessage = 'Giriş yapılırken bir hata oluştu.';
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Giriş iptal edildi.';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Ağ hatası. İnternet bağlantınızı kontrol edin.';
                } else if (error.code === 'auth/unauthorized-domain') {
                    errorMessage = 'Bu domain için giriş yetkisi yok. Firebase Console\'da domain\'i ekleyin.';
                }
                
                showStatus(errorMessage, 'error');
                googleSignInBtn.disabled = false;
            }
        }

        // Handle Sign Out
        async function handleSignOut() {
            try {
                await signOut(auth);
                console.log('Çıkış başarılı');
                showStatus('Çıkış yapıldı.', 'success');
            } catch (error) {
                console.error('Çıkış hatası:', error);
                showStatus('Çıkış yapılırken hata oluştu.', 'error');
            }
        }

        // Update UI based on auth state
        function updateUI(user) {
            if (user) {
                // User is signed in
                googleSignInBtn.style.display = 'none';
                userInfo.style.display = 'block';
                
                userName.textContent = user.displayName || 'Kullanıcı';
                userEmail.textContent = user.email || '';
                
                if (user.photoURL) {
                    userAvatar.src = user.photoURL;
                } else {
                    userAvatar.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjUiIGZpbGw9IiM2MjY5NzYiLz4KPHN2ZyB4PSIxMiIgeT0iMTIiIHdpZHRoPSIyNiIgaGVpZ2h0PSIyNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAxMmMyLjIxIDAgNC0xLjc5IDQtNHMtMS43OS00LTQtNC00IDEuNzktNCA0IDEuNzkgNCA0IDR6bTAgMmMtMi42NyAwLTggMS4zNC04IDR2MmgxNnYtMmMwLTIuNjYtNS4zMy00LTgtNHoiLz4KPC9zdmc+Cjwvc3ZnPgo=';
                }
                
            } else {
                // User is signed out
                googleSignInBtn.style.display = 'flex';
                userInfo.style.display = 'none';
                googleSignInBtn.disabled = false;
            }
        }

        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            console.log('Auth state changed:', user ? 'User signed in' : 'User signed out');
            updateUI(user);
            
            if (user) {
                // Tüm popüler yerleri ve ülkeleri topla
                const allPopularPlaces = await getAllPopularPlaces();
                const allCountryCodes = await getAllPopularCountryCodes();
                // Kullanıcının mevcut yerlerini çek
                const userPlacesRef = collection(db, `users/${user.uid}/places`);
                const snapshot = await getDocs(userPlacesRef);
                const existingPlaces = new Map();
                snapshot.forEach(doc => {
                    const d = doc.data();
                    const key = `${(d.country || '').toUpperCase()}|||${(d.name || '').trim()}`;
                    existingPlaces.set(key, { ...d, docId: doc.id });
                });
                // Eksik popüler yerleri ekle
                let addedCount = 0;
                for (const p of allPopularPlaces) {
                    const country = (p.country_tr || p.country_en || '').toUpperCase();
                    const name = p.name_tr;
                    const key = `${country}|||${name}`;
                    if (!existingPlaces.has(key)) {
                        await addDoc(userPlacesRef, filterUndefinedFields({
                            name: p.name_tr,
                            city: p.city_tr,
                            country: p.country_tr ? p.country_tr.toUpperCase() : undefined,
                            category: p.category_tr,
                            description: p.description_tr,
                            visited: false,
                            name_en: p.name_en,
                            city_en: p.city_en,
                            country_en: p.country_en ? p.country_en.toUpperCase() : undefined,
                            category_en: p.category_en,
                            description_en: p.description_en
                        }));
                        addedCount++;
                    } else {
                        // Açıklama eksikse güncelle
                        const place = existingPlaces.get(key);
                        if (!place.description || place.description.trim() === '') {
                            const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js');
                            const docRef = doc(db, `users/${user.uid}/places`, place.docId);
                            await updateDoc(docRef, filterUndefinedFields({
                                description: p.description_tr,
                                name_en: p.name_en,
                                city_en: p.city_en,
                                country_en: p.country_en ? p.country_en.toUpperCase() : undefined,
                                category_en: p.category_en,
                                description_en: p.description_en
                            }));
                        }
                    }
                }
                if (addedCount > 0) showStatus(`${addedCount} yeni popüler yer otomatik eklendi!`, 'success');
                else showStatus('Tüm popüler yerler zaten mevcut.', 'info');
                // Ülke dropdown'ını güncelle
                await updateCountryDropdown(user, allCountryCodes);
            }
            
            loadPlacesTable(user);
        });

        // Event listeners
        googleSignInBtn.addEventListener('click', handleGoogleSignIn);
        logoutBtn.addEventListener('click', handleSignOut);
        
        // Awesomplete ile öneri getir
        const awesomplete = new Awesomplete(searchBox, {
          minChars: 2,
          maxItems: 10,
          autoFirst: true,
          list: [],
          item: function(suggestion, input) {
            // Açıklama başlığın altında değil, başlığın hemen üstünde olacak şekilde düzenle
            const html = `<div style='display:flex;flex-direction:column;'>
              <span style='font-size:12px;color:#888;margin-bottom:2px;'>${suggestion.description || ''}</span>
              <strong>${suggestion.label}</strong>
            </div>`;
            const li = document.createElement('li');
            li.innerHTML = html;
            return li;
          },
          replace: function(suggestion) {
            this.input.value = suggestion.label;
          }
        });
        let lastSuggestions = [];
        searchBox.addEventListener('input', async () => {
          const query = searchBox.value.trim();
          if (!query) {
            awesomplete.list = [];
            lastSuggestions = [];
            return;
          }
          // Wikipedia'dan çek
          let wikiResults = [];
          try {
            const url = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*`;
            const resp = await fetch(url);
            const data = await resp.json();
            if (data.query && data.query.search) {
              // Sıkı filtre: sadece gezilecek yer anahtar kelimeleriyle filtrele
              const keywords = [
                "city", "town", "village", "park", "mountain", "lake", "museum", "site", "ruins", "castle", "beach", "island", "national park", "tourist attraction", "region", "province", "area", "district", "valley", "canyon", "bay", "forest", "desert", "archaeological", "ancient", "historic", "landmark", "monument", "temple", "cathedral", "mosque", "church", "palace", "bazaar", "market", "bridge", "tower", "garden", "zoo", "aquarium", "harbor", "canal", "square", "plaza", "avenue", "boulevard", "road", "street", "avenue", "hill", "peninsula", "cape", "fjord", "waterfall", "thermal", "spa", "resort", "cave", "gorge", "cliff", "archipelago", "reef", "lagoon", "reserve", "parkway", "route", "trail", "sanctuary", "shrine", "abbey", "fortress", "citadel", "basilica", "synagogue", "pagoda", "pagoda", "shrine", "observatory", "planetarium", "amphitheater", "arena", "stadium", "arena", "theater", "opera", "gallery", "exhibition", "museum", "library", "university", "college", "campus", "cemetery", "mausoleum", "tomb", "crypt", "memorial", "obelisk", "column", "statue", "sculpture", "fountain", "spring", "lake", "pond", "reservoir", "dam", "canal", "lock", "aqueduct", "viaduct", "causeway", "embankment", "jetty", "pier", "dock", "marina", "port", "wharf", "quay", "shipyard", "boatyard", "lighthouse", "windmill", "mill", "factory", "brewery", "winery", "distillery", "vineyard", "orchard", "farm", "ranch", "plantation", "garden", "arboretum", "botanical", "zoo", "aquarium", "aviary", "menagerie", "safari", "park", "reserve", "sanctuary", "refuge", "conservancy", "wilderness", "wildlife", "nature", "natural", "scenic", "viewpoint", "overlook", "panorama", "vista", "lookout", "observation", "deck", "platform", "tower", "hill", "mount", "mountain", "peak", "summit", "ridge", "range", "plateau", "mesa", "butte", "knob", "dome", "crag", "pinnacle", "spires", "needle", "spire", "rock", "boulder", "cliff", "bluff", "escarpment", "gorge", "ravine", "gulch", "canyon", "valley", "dale", "dell", "glen", "hollow", "notch", "pass", "gap", "col", "saddle", "divide", "watershed", "basin", "plain", "prairie", "steppe", "savanna", "meadow", "field", "pasture", "heath", "moor", "fen", "bog", "swamp", "marsh", "wetland", "delta", "estuary", "bayou", "inlet", "cove", "bight", "gulf", "bay", "sound", "strait", "channel", "passage", "fjord", "sea", "ocean", "coast", "shore", "beach", "bank", "bar", "reef", "atoll", "island", "isle", "islet", "key", "cay", "archipelago", "peninsula", "cape", "point", "head", "headland", "promontory", "spit", "hook", "tongue", "neck", "land", "landmark"
              ];
              wikiResults = data.query.search.filter(item => {
                const text = (item.title + ' ' + item.snippet).toLowerCase();
                return keywords.some(kw => text.includes(kw));
              }).map(item => ({
                label: item.title,
                value: item.title,
                description: item.snippet.replace(/<[^>]+>/g, ''),
                source: 'wikipedia'
              }));
            }
          } catch {}
          // Geonames'den çek
          let geoResults = [];
          try {
            const geoUrl = `https://secure.geonames.org/searchJSON?q=${encodeURIComponent(query)}&maxRows=10&username=${GEONAMES_USERNAME}`;
            const geoResp = await fetch(geoUrl);
            const geoData = await geoResp.json();
            if (geoData.geonames) {
              geoResults = geoData.geonames.map(g => ({
                label: g.name,
                value: g.name,
                description: `${g.countryName || ''} ${g.fcodeName || ''}`,
                source: 'geonames'
              }));
            }
          } catch {}
          // Sonuçları birleştir, tekrarları ayıkla
          const allResults = [...wikiResults, ...geoResults].filter((v, i, a) =>
            a.findIndex(t => t.value === v.value) === i
          );
          awesomplete.list = allResults;
          lastSuggestions = allResults;
        });
        // Seçim veya enter ile ekle
        searchBox.addEventListener('awesomplete-selectcomplete', async (e) => {
          const user = auth.currentUser;
          if (!user) {
            showStatus('Giriş yapmadan yer ekleyemezsiniz.', 'error');
            return;
          }
          const selectedLabel = searchBox.value.trim();
          const item = lastSuggestions.find(s => s.label === selectedLabel) || { value: selectedLabel, description: '', source: 'manual' };
          addPlaceBtn.disabled = true;
          try {
            await addDoc(collection(db, `users/${user.uid}/places`), {
              name: item.value,
              city: '',
              country: (countryFilter.value || '').toUpperCase(),
              category: '',
              description: item.description || '',
              visited: false
            });
            showStatus('Yeni yer eklendi!', 'success');
            searchBox.value = '';
            addPlaceBtn.disabled = false;
            loadPlacesTable(user);
          } catch (err) {
            showStatus('Yer eklenirken hata: ' + err.message, 'error');
            addPlaceBtn.disabled = false;
          }
        });

        // Initialize
        console.log('Firebase initialized successfully');
        showStatus('Uygulama hazır. Giriş yapabilirsiniz.', 'info');

        // Popüler yerler JSON'ını yükle ve işle
        async function loadPopularPlaces() {
          try {
            const response = await fetch('/popular-places.json');
            const popularPlaces = await response.json();
            return popularPlaces;
          } catch (error) {
            console.error('Popüler yerler yüklenemedi:', error);
            return [];
          }
        }

        // Yeni kullanıcı için popüler yerleri yükle
        async function loadPopularPlacesForNewUser(user) {
          try {
            const popularPlaces = await loadPopularPlaces();
            const userPlacesRef = collection(db, `users/${user.uid}/places`);
            
            // Kullanıcının mevcut yerlerini kontrol et
            const existingSnapshot = await getDocs(userPlacesRef);
            const existingPlaces = new Set();
            existingSnapshot.forEach(doc => {
              const data = doc.data();
              // Hem Türkçe hem İngilizce isimleri kontrol et
              existingPlaces.add(`${data.name}-${data.country}`);
              if (data.name_en) {
                existingPlaces.add(`${data.name_en}-${data.country_en || data.country}`);
              }
            });

            // Popüler yerleri ekle (eğer yoksa)
            let addedCount = 0;
            for (const place of popularPlaces) {
              const placeKeyTr = `${place.name_tr}-${place.country_tr.toUpperCase()}`;
              const placeKeyEn = `${place.name_en}-${place.country_en.toUpperCase()}`;
              
              if (!existingPlaces.has(placeKeyTr) && !existingPlaces.has(placeKeyEn)) {
                await addDoc(userPlacesRef, {
                  name: place.name_tr,
                  city: place.city_tr,
                  country: place.country_tr.toUpperCase(),
                  category: place.category_tr,
                  description: place.description_tr,
                  visited: false,
                  name_en: place.name_en,
                  city_en: place.city_en,
                  country_en: place.country_en.toUpperCase(),
                  category_en: place.category_en,
                  description_en: place.description_en
                });
                addedCount++;
              }
            }
            
            if (addedCount > 0) {
              showStatus(`${addedCount} popüler yer eklendi!`, 'success');
            } else {
              showStatus('Tüm popüler yerler zaten mevcut.', 'info');
            }
          } catch (error) {
            console.error('Popüler yerler yüklenirken hata:', error);
            showStatus('Popüler yerler yüklenirken hata oluştu: ' + error.message, 'error');
          }
        }

        // Firestore'a undefined alan göndermeyi engelleyen yardımcı fonksiyon
        function filterUndefinedFields(obj) {
          const result = {};
          for (const key in obj) {
            if (obj[key] !== undefined) {
              result[key] = obj[key];
            }
          }
          return result;
        }

        // Mevcut kullanıcı için eksik açıklamaları doldur
        async function fillMissingDescriptions(user) {
          try {
            const popularPlaces = await loadPopularPlaces();
            const userPlacesRef = collection(db, `users/${user.uid}/places`);
            const snapshot = await getDocs(userPlacesRef);
            
            let updatedCount = 0;
            const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js');
            
            for (const docSnapshot of snapshot.docs) {
              const data = docSnapshot.data();
              // Açıklama eksikse popüler yerlerden bul
              if (!data.description || data.description.trim() === '') {
                // Hem Türkçe hem İngilizce isimlerle eşleştir
                let matchingPlace = popularPlaces.find(place => 
                  (place.name_tr === data.name && place.country_tr.toUpperCase() === data.country) ||
                  (place.name_en === data.name && place.country_en.toUpperCase() === data.country)
                );
                
                // Eğer bulunamazsa, sadece isimle eşleştir
                if (!matchingPlace) {
                  matchingPlace = popularPlaces.find(place => 
                    place.name_tr === data.name || place.name_en === data.name
                  );
                }
                
                if (matchingPlace) {
                  const docRef = doc(db, `users/${user.uid}/places`, docSnapshot.id);
                  await updateDoc(docRef, {
                    description: matchingPlace.description_tr,
                    name_en: matchingPlace.name_en,
                    city_en: matchingPlace.city_en,
                    country_en: matchingPlace.country_en.toUpperCase(),
                    category_en: matchingPlace.category_en,
                    description_en: matchingPlace.description_en
                  });
                  updatedCount++;
                }
              }
            }
            
            if (updatedCount > 0) {
              showStatus(`${updatedCount} yerin açıklaması güncellendi!`, 'success');
            } else {
              showStatus('Güncellenecek açıklama bulunamadı.', 'info');
            }
          } catch (error) {
            console.error('Açıklamalar doldurulurken hata:', error);
            showStatus('Açıklamalar doldurulurken hata oluştu: ' + error.message, 'error');
          }
        }

        // Ülke kayıtlarını birleştir ve eksik yerleri ekle
        async function mergeCountriesAndAddMissingPlaces(user) {
          try {
            const popularPlaces = await loadPopularPlaces();
            const userPlacesRef = collection(db, `users/${user.uid}/places`);
            const snapshot = await getDocs(userPlacesRef);
            const { doc, updateDoc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js');

            // Tüm yerleri ülke+isim kombinasyonuna göre grupla
            const placeMap = new Map();
            const toDelete = [];
            for (const docSnapshot of snapshot.docs) {
              const data = docSnapshot.data();
              const country = (data.country || '').toUpperCase();
              const name = (data.name || '').trim();
              const key = `${country}|||${name}`;
              if (!placeMap.has(key)) {
                placeMap.set(key, { ...data, docId: docSnapshot.id });
              } else {
                // Aynı ülke ve isimde birden fazla kayıt varsa, sadece birini bırak
                toDelete.push(docSnapshot.id);
              }
            }

            // Silinecek tekrar eden kayıtları sil
            for (const docId of toDelete) {
              const docRef = doc(db, `users/${user.uid}/places`, docId);
              await deleteDoc(docRef);
            }

            // Açıklamaları güncelle ve eksik popüler yerleri ekle
            let updatedCount = 0;
            let addedCount = 0;
            const existingKeys = new Set(placeMap.keys());
            // Açıklamaları güncelle
            for (const [key, place] of placeMap.entries()) {
              if (!place.description || place.description.trim() === '') {
                const [country, name] = key.split('|||');
                const matching = popularPlaces.find(p =>
                  (p.country_tr && p.country_tr.toUpperCase() === country && p.name_tr === name) ||
                  (p.country_en && p.country_en.toUpperCase() === country && p.name_en === name)
                );
                if (matching) {
                  const docRef = doc(db, `users/${user.uid}/places`, place.docId);
                  await updateDoc(docRef, filterUndefinedFields({
                    description: matching.description_tr,
                    name_en: matching.name_en,
                    city_en: matching.city_en,
                    country_en: matching.country_en ? matching.country_en.toUpperCase() : undefined,
                    category_en: matching.category_en,
                    description_en: matching.description_en
                  }));
                  updatedCount++;
                }
              }
            }
            // Eksik popüler yerleri ekle
            for (const p of popularPlaces) {
              const country = (p.country_tr || p.country_en || '').toUpperCase();
              const name = p.name_tr;
              const key = `${country}|||${name}`;
              if (!existingKeys.has(key)) {
                await addDoc(userPlacesRef, filterUndefinedFields({
                  name: p.name_tr,
                  city: p.city_tr,
                  country: p.country_tr ? p.country_tr.toUpperCase() : undefined,
                  category: p.category_tr,
                  description: p.description_tr,
                  visited: false,
                  name_en: p.name_en,
                  city_en: p.city_en,
                  country_en: p.country_en ? p.country_en.toUpperCase() : undefined,
                  category_en: p.category_en,
                  description_en: p.description_en
                }));
                addedCount++;
              }
            }
            let msg = '';
            if (toDelete.length > 0) msg += `${toDelete.length} tekrar eden kayıt silindi. `;
            if (updatedCount > 0) msg += `${updatedCount} açıklama güncellendi. `;
            if (addedCount > 0) msg += `${addedCount} yeni yer eklendi.`;
            if (!msg) msg = 'Herhangi bir değişiklik yapılmadı.';
            showStatus(msg, 'success');
          } catch (error) {
            console.error('Ülke birleştirme hatası:', error);
            showStatus('Ülke birleştirme hatası: ' + error.message, 'error');
          }
        }

        async function loadPlacesTable(user) {
          if (!user) {
            placesTableContainer.style.display = 'none';
            return;
          }
          // Kullanıcıya ait places koleksiyonu yolu
          const placesCol = collection(db, `users/${user.uid}/places`);
          const snapshot = await getDocs(placesCol);

          // Tabloyu temizle
          placesTableBody.innerHTML = '';

          // Filtre comboboxlarını hazırla
          const countryFilter = document.getElementById('countryFilter');
          const visitedFilter = document.getElementById('visitedFilter');
          // Arama kutusu sadece öneri için, filtreleme yok

          // Tüm ülkeleri topla ve normalize et
          const places = [];
          const countrySet = new Set();
          snapshot.forEach(doc => {
            const data = doc.data();
            places.push({ ...data, _docId: doc.id });
            if (data.country) {
              // İngilizce anahtara normalize et
              const englishKey = getEnglishCountryKeySafe(data.country);
              countrySet.add(englishKey);
            }
          });
          const countries = Array.from(countrySet).sort();

          // Ülke combobox'ını doldur (sadece ilk yüklemede veya ülke sayısı değiştiyse)
          if (countryFilter.options.length === 0 || countryFilter.options.length !== countries.length) {
            countryFilter.innerHTML = '';
            countries.forEach(englishKey => {
              const opt = document.createElement('option');
              opt.value = englishKey;
              opt.textContent = countryNames[englishKey]?.[currentLang] || englishKey.toUpperCase();
              countryFilter.appendChild(opt);
            });
          }
          // Varsayılan ülke: ALMANYA
          if (!countryFilter.value) countryFilter.value = 'ALMANYA';
          // Varsayılan ziyaret filtresi: Gezilmedi
          if (!visitedFilter.value) visitedFilter.value = 'notvisited';

          // Filtreye göre verileri süz
          let filtered = [];
          const selectedCountry = countryFilter.value;
          const selectedVisited = visitedFilter.value;
          filtered = places.filter(p => getEnglishCountryKeySafe(p.country) === selectedCountry);
          if (selectedVisited === 'visited') filtered = filtered.filter(p => p.visited);
          else if (selectedVisited === 'notvisited') filtered = filtered.filter(p => !p.visited);

          filtered.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
          filtered.forEach(data => {
            const row = document.createElement('tr');
            const categoryHtml = (data.category || '').replace(/\s*\/\s*/g, '<br>');
            row.innerHTML = `
              <td class="name">${data.name || ''}</td>
              <td>${data.city || ''}</td>
              <td>${categoryHtml}</td>
              <td class="description">${data.description || ''}</td>
              <td style="text-align:center;"><input type="checkbox" class="visited-checkbox" data-docid="${data._docId}" ${data.visited ? 'checked' : ''}></td>
              <td style="text-align:center;"><button class="delete-place-btn" data-docid="${data._docId}" style="background:#dc3545;color:white;border:none;padding:4px 10px;border-radius:5px;cursor:pointer;">Sil</button></td>
            `;
            placesTableBody.appendChild(row);
          });

          // Checkbox event listener
          document.querySelectorAll('.visited-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', async (e) => {
              const docId = e.target.getAttribute('data-docid');
              const checked = e.target.checked;
              try {
                const placeDocRef = collection(db, `users/${user.uid}/places`);
                // Firestore doc() ile referans oluştur
                const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js');
                const ref = doc(db, `users/${user.uid}/places`, docId);
                await updateDoc(ref, { visited: checked });
              } catch (err) {
                alert('Güncelleme hatası: ' + err.message);
                e.target.checked = !checked; // Hata olursa eski haline döndür
              }
            });
          });

          // Silme butonu event listener
          document.querySelectorAll('.delete-place-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              const docId = e.target.getAttribute('data-docid');
              if (!confirm('Bu yeri silmek istediğinize emin misiniz?')) return;
              try {
                const { doc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js');
                const ref = doc(db, `users/${user.uid}/places`, docId);
                await deleteDoc(ref);
                showStatus('Yer silindi.', 'success');
                loadPlacesTable(user);
              } catch (err) {
                showStatus('Silme hatası: ' + err.message, 'error');
              }
            });
          });

          placesTableContainer.style.display = '';
        }

        // Filtre değişince tabloyu güncelle
        document.addEventListener('DOMContentLoaded', () => {
          const countryFilter = document.getElementById('countryFilter');
          const visitedFilter = document.getElementById('visitedFilter');
          if (countryFilter && visitedFilter) {
            countryFilter.addEventListener('change', () => {
              const user = auth.currentUser;
              if (user) loadPlacesTable(user);
              if (window.enhancedBackgroundManager) {
                window.enhancedBackgroundManager.updateBackgroundForCountry(countryFilter.value);
              }
            });
            visitedFilter.addEventListener('change', () => {
              const user = auth.currentUser;
              if (user) loadPlacesTable(user);
            });
            // --- Sayfa ilk açıldığında da arka planı güncelle ---
            setTimeout(() => {
              if (window.enhancedBackgroundManager && countryFilter.value) {
                window.enhancedBackgroundManager.updateBackgroundForCountry(countryFilter.value);
              }
            }, 100);
          }
        });

        // Tüm popüler ülke JSON dosyalarını otomatik bul ve oku
        async function getAllPopularCountryFiles() {
          // public/json/popular-*.json dosyalarını bulmak için bir endpoint veya sabit liste gerekir
          // Burada sabit bir listeyle ilerliyoruz (daha sonra dinamik yapılabilir)
          const countryFiles = [
            'popular-germany.json', 'popular-france.json', 'popular-italy.json', 'popular-spain.json', 'popular-netherlands.json',
            'popular-switzerland.json', 'popular-belgium.json', 'popular-austria.json', 'popular-poland.json', 'popular-czech-republic.json',
            'popular-hungary.json', 'popular-romania.json', 'popular-greece.json', 'popular-portugal.json', 'popular-croatia.json',
            'popular-slovenia.json', 'popular-bulgaria.json', 'popular-slovakia.json', 'popular-estonia.json', 'popular-latvia.json',
            'popular-lithuania.json', 'popular-south-korea.json', 'popular-japan.json', 'popular-turkey.json', 'popular-uk.json', 'popular-ireland.json'
          ];
          const base = '/json/';
          const all = [];
          for (const file of countryFiles) {
            try {
              const resp = await fetch(base + file);
              if (resp.ok) {
                const arr = await resp.json();
                all.push({ file, arr });
              }
            } catch {}
          }
          return all;
        }

        // Tüm ülkelerin kodlarını ve isimlerini döndür
        async function getAllPopularCountryCodes() {
          const all = await getAllPopularCountryFiles();
          const codes = new Set();
          all.forEach(({ arr }) => {
            arr.forEach(p => {
              if (p.country_tr) codes.add(p.country_tr.toUpperCase());
              if (p.country_en) codes.add(p.country_en.toUpperCase());
            });
          });
          return Array.from(codes).sort();
        }

        // Tüm popüler yerleri tek dizi olarak döndür
        async function getAllPopularPlaces() {
          const all = await getAllPopularCountryFiles();
          return all.flatMap(({ arr }) => arr);
        }

        // Ülke dropdown'ını tüm popüler ülkelerle güncelle
        async function updateCountryDropdown(user, allCountryCodes) {
          const countryFilter = document.getElementById('countryFilter');
          if (!countryFilter) return;
          countryFilter.innerHTML = '';
          allCountryCodes.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.textContent = c;
            countryFilter.appendChild(opt);
          });
          // Kullanıcının mevcut ülkesini koru
          if (!countryFilter.value) countryFilter.value = 'ALMANYA';
        }

        function getEnglishCountryKeySafe(country) {
          if (window.enhancedBackgroundManager && typeof window.enhancedBackgroundManager.getEnglishCountryKey === 'function') {
            return window.enhancedBackgroundManager.getEnglishCountryKey(country);
          }
          // Local fallback (kısa versiyon)
          const map = {
            'türkiye': 'turkey', 'almanya': 'germany', 'fransa': 'france', 'italya': 'italy', 'ispanya': 'spain',
            'yunanistan': 'greece', 'hollanda': 'netherlands', 'belçika': 'belgium', 'avusturya': 'austria',
            'isviçre': 'switzerland', 'portekiz': 'portugal', 'çek cumhuriyeti': 'czech republic', 'polonya': 'poland',
            'romanya': 'romania', 'bulgaristan': 'bulgaria', 'letonya': 'latvia', 'litvanya': 'lithuania',
            'estonya': 'estonia', 'macaristan': 'hungary', 'slovakya': 'slovakia', 'slovenya': 'slovenia',
            'hirvatistan': 'croatia', 'sırbistan': 'serbia', 'ukrayna': 'ukraine', 'norveç': 'norway',
            'isveç': 'sweden', 'finlandiya': 'finland', 'güney kore': 'south korea', 'japonya': 'japan',
            'çin': 'china', 'abd': 'usa', 'amerika': 'usa', 'birleşik krallık': 'uk'
          };
          const norm = country.toLowerCase().replace(/ç/g,'c').replace(/ğ/g,'g').replace(/ı/g,'i').replace(/ö/g,'o').replace(/ş/g,'s').replace(/ü/g,'u');
          return map[norm] || norm;
        }

        // Gelişmiş Türkçe büyük harf dönüşümü fonksiyonu
        function toTurkishUpper(str) {
          return str
            .replace(/i/g, 'İ')
            .replace(/ı/g, 'I')
            .replace(/I/g, 'İ')
            .replace(/ş/g, 'Ş')
            .replace(/ğ/g, 'Ğ')
            .replace(/ü/g, 'Ü')
            .replace(/ö/g, 'Ö')
            .replace(/ç/g, 'Ç')
            .toUpperCase();
        }

        // --- Ülke combobox'ını Türkçe isme göre alfabetik sırala ---
        async function updateCountryDropdownWithPopularOnly() {
          const countryFilter = document.getElementById('countryFilter');
          if (!countryFilter) return;
          // 1. Popüler ülkeleri oku
          const allPopular = await getAllPopularCountryCodes(); // normalize edilmiş İngilizce anahtarlar
          // 2. Tekrarları engelle
          const allCountries = Array.from(new Set(allPopular));
          // 3. Türkçe isme göre sırala
          allCountries.sort((a, b) => {
            const trA = toTurkishUpper(countryNames[a]?.[currentLang] || a);
            const trB = toTurkishUpper(countryNames[b]?.[currentLang] || b);
            return trA.localeCompare(trB, 'tr');
          });
          // 4. Dropdown'u doldur
          countryFilter.innerHTML = '';
          allCountries.forEach(englishKey => {
            const opt = document.createElement('option');
            opt.value = englishKey;
            const trName = countryNames[englishKey]?.[currentLang] || englishKey;
            opt.textContent = toTurkishUpper(trName);
            countryFilter.appendChild(opt);
          });
          // Varsayılan ülke: ALMANYA
          if (!countryFilter.value && allCountries.includes('germany')) countryFilter.value = 'germany';
        }

        // --- Sayfa ilk açıldığında ve kullanıcı değiştiğinde ülke dropdown'unu güncelle ---
        document.addEventListener('DOMContentLoaded', () => {
          updateCountryDropdownWithPopularOnly();
        });
    </script>
    <script src="/js/enhanced-background-manager.js"></script>
</body>

</html> 